"""
Apollo Federation v2 Schema Configuration
This schema participates in Apollo Federation as a subgraph
"""
extend schema
  @link(url: "https://specs.apollo.dev/federation/v2.0")

"A datetime string with format `Y-m-d H:i:s`, e.g. `2018-05-23 13:43:32`."
scalar DateTime @scalar(class: "Nuwave\\Lighthouse\\Schema\\Types\\Scalars\\DateTime")

"Indicates what fields are available at the top level of a query operation."
type Query {
    "Get current authenticated user"
    me: User @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@me")

    "Validate authentication token"
    validateToken(token: String!): ValidationResponse! @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@validateToken")

    "Find a single user by ID"
    user(id: ID! @rules(apply: ["required"])): User @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@user")

    "List all users with pagination"
    users(
        first: Int = 10
        page: Int = 1
    ): UserPagination! @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@users")

    "Get all roles"
    roles: [Role!]! @field(resolver: "App\\GraphQL\\Resolvers\\RolePermissionResolver@roles")

    "Get all permissions"
    permissions: [Permission!]! @field(resolver: "App\\GraphQL\\Resolvers\\RolePermissionResolver@permissions")

    "Get user permissions"
    userPermissions: [Permission!]! @field(resolver: "App\\GraphQL\\Resolvers\\RolePermissionResolver@userPermissions")
}

"Mutations for authentication and user management"
type Mutation {
    "User login with email and password"
    login(email: String! @rules(apply: ["required", "email"]), password: String! @rules(apply: ["required", "min:8"])): AuthResponse! @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@login")

    "Login via WhatsApp (phone number)"
    loginWhatsApp(phone: String! @rules(apply: ["required"])): AuthResponse! @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@loginWhatsApp")

    "User logout - revokes token"
    logout: LogoutResponse! @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@logout")

    "Refresh authentication token"
    refreshToken(token: String!): AuthResponse! @field(resolver: "App\\GraphQL\\Resolvers\\AuthResolver@refreshToken")

    "Create new user (admin only)"
    createUser(
        email: String! @rules(apply: ["required", "email", "unique:users"])
        phone: String @rules(apply: ["unique:users"])
        name: String! @rules(apply: ["required", "string", "max:255"])
        password: String! @rules(apply: ["required", "min:8"])
        roleId: ID!
    ): UserResponse! @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@createUser")

    "Update user data"
    updateUser(
        id: ID! @rules(apply: ["required"])
        name: String
        phone: String
        email: String @rules(apply: ["email", "unique:users,email,{id}"])
    ): UserResponse! @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@updateUser")

    "Delete a user"
    deleteUser(id: ID! @rules(apply: ["required"])): DeleteResponse! @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@deleteUser")

    "Assign role to user"
    assignRoleToUser(userId: ID!, roleId: ID!): UserResponse! @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@assignRoleToUser")

    "Remove role from user"
    removeRoleFromUser(userId: ID!, roleId: ID!): UserResponse! @field(resolver: "App\\GraphQL\\Resolvers\\UserResolver@removeRoleFromUser")
}

"User account type - Primary entity in authentication service"
type User @key(fields: "id") {
    "Unique primary key"
    id: ID!

    "User full name"
    name: String!

    "User email address"
    email: String!

    "User phone number (WhatsApp)"
    phone: String

    "User status (active/inactive)"
    status: String!

    "User roles"
    roles: [Role!]!

    "User permissions"
    permissions: [Permission!]!

    "When email was verified"
    emailVerifiedAt: DateTime

    "When account was created"
    createdAt: DateTime!

    "When account was last updated"
    updatedAt: DateTime!
}

"Paginated user response"
type UserPagination {
    data: [User!]!
    paginatorInfo: PaginatorInfo!
}

"Pagination information"
type PaginatorInfo {
    count: Int!
    currentPage: Int!
    firstItem: Int
    hasMorePages: Boolean!
    lastItem: Int
    lastPage: Int!
    perPage: Int!
    total: Int!
}

"Role type"
type Role @key(fields: "id") {
    "Unique role ID"
    id: ID!

    "Role name"
    name: String!

    "Role description"
    description: String

    "Permissions assigned to this role"
    permissions: [Permission!]!

    "When role was created"
    createdAt: DateTime!

    "When role was last updated"
    updatedAt: DateTime!
}

"Permission type"
type Permission @key(fields: "id") {
    "Unique permission ID"
    id: ID!

    "Permission name"
    name: String!

    "Permission description"
    description: String

    "When permission was created"
    createdAt: DateTime!

    "When permission was last updated"
    updatedAt: DateTime!
}

"Authentication response"
type AuthResponse {
    "Operation success status"
    success: Boolean!

    "Response message"
    message: String

    "Authentication token"
    token: String!

    "Token type (Bearer)"
    tokenType: String!

    "Token expiration time"
    expiresAt: String

    "Authenticated user"
    user: User!

    "User permissions"
    permissions: [Permission!]
}

"User response"
type UserResponse {
    success: Boolean!
    message: String!
    user: User
}

"Logout response"
type LogoutResponse {
    success: Boolean!
    message: String!
}

"Delete response"
type DeleteResponse {
    success: Boolean!
    message: String!
}

"Token validation response"
type ValidationResponse {
    isValid: Boolean!
    expiresAt: String
    userId: ID
    message: String
}
